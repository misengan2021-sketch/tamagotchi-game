name: Android CI (debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Unzip project
        run: |
          unzip tamagotchi_full_project.zip -d project
          ls project
      - name: Remove old UI MainActivity
        run: |
          rm -f project/app/src/main/java/com/example/tamagotchi/ui/MainActivity.kt || true

      - name: Rewrite AndroidManifest
        run: |
          mkdir -p project/app/src/main
          cat <<'EOF' > project/app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <application
                  android:allowBackup="true"
                  android:label="Tamagotchi"
                  android:icon="@android:drawable/ic_dialog_info"
                  android:roundIcon="@android:drawable/ic_dialog_info"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>

          </manifest>
          EOF

      - name: Create MainActivity.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi
          cat <<'EOF' > project/app/src/main/java/com/example/tamagotchi/MainActivity.kt
          package com.example.tamagotchi

          import android.os.Bundle
          import androidx.activity.ComponentActivity
          import androidx.activity.compose.setContent
          import androidx.activity.viewModels
          import androidx.compose.foundation.clickable
          import androidx.compose.foundation.layout.*
          import androidx.compose.foundation.lazy.LazyRow
          import androidx.compose.foundation.lazy.itemsIndexed
          import androidx.compose.material.*
          import androidx.compose.runtime.*
          import androidx.compose.ui.Alignment
          import androidx.compose.ui.Modifier
          import androidx.compose.ui.text.font.FontWeight
          import androidx.compose.ui.unit.dp
          import androidx.compose.ui.unit.sp
          import com.example.tamagotchi.model.Pet
          import com.example.tamagotchi.viewmodel.MultiTamagotchiViewModel

          class MainActivity : ComponentActivity() {

              private val vm: MultiTamagotchiViewModel by viewModels()

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContent {
                      MaterialTheme {
                          Surface(
                              modifier = Modifier.fillMaxSize(),
                              color = MaterialTheme.colors.background
                          ) {
                              MainGameScreen(vm = vm)
                          }
                      }
                  }
              }
          }

          @Composable
          fun MainGameScreen(vm: MultiTamagotchiViewModel) {
              val pets = vm.pets
              val selectedIndex = vm.selectedIndex
              val selectedPet = vm.selectedPet

              var newPetName by remember { mutableStateOf("") }

              if (selectedPet == null && pets.isNotEmpty()) {
                  vm.select(0)
              }

              Column(
                  modifier = Modifier
                      .fillMaxSize()
                      .padding(16.dp),
                  verticalArrangement = Arrangement.spacedBy(16.dp)
              ) {

                  Text(
                      text = "Tamagotchi Multi",
                      style = MaterialTheme.typography.h5,
                      fontWeight = FontWeight.Bold
                  )

                  if (pets.isNotEmpty()) {
                      LazyRow(
                          horizontalArrangement = Arrangement.spacedBy(8.dp),
                          modifier = Modifier.fillMaxWidth()
                      ) {
                          itemsIndexed(pets) { index, pet ->
                              PetChip(
                                  pet = pet,
                                  selected = index == selectedIndex,
                                  onClick = { vm.select(index) }
                              )
                          }
                      }
                  } else {
                      Text("–ü–∏—Ç–æ–º—Ü–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ üëá")
                  }

                  Divider()

                  selectedPet?.let { pet ->
                      SelectedPetCard(
                          pet = pet,
                          onFeed = { vm.feedSelected() },
                          onPlay = { vm.playSelected() },
                          onReset = { vm.resetSelected() }
                      )
                  }

                  Spacer(modifier = Modifier.height(16.dp))

                  Text("–î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞", fontWeight = FontWeight.Bold)
                  Row(
                      horizontalArrangement = Arrangement.spacedBy(8.dp),
                      modifier = Modifier.fillMaxWidth()
                  ) {
                      OutlinedTextField(
                          value = newPetName,
                          onValueChange = { newPetName = it },
                          modifier = Modifier.weight(1f),
                          label = { Text("–ò–º—è") }
                      )
                      Button(
                          onClick = {
                              if (newPetName.isNotBlank()) {
                                  vm.addPet(newPetName.trim())
                                  newPetName = ""
                              }
                          },
                          modifier = Modifier.align(Alignment.CenterVertically)
                      ) {
                          Text("–°–æ–∑–¥–∞—Ç—å")
                      }
                  }
              }
          }

          @Composable
          fun PetChip(pet: Pet, selected: Boolean, onClick: () -> Unit) {
              Surface(
                  shape = MaterialTheme.shapes.medium,
                  elevation = if (selected) 6.dp else 2.dp,
                  modifier = Modifier.clickable(onClick = onClick)
              ) {
                  Column(
                      modifier = Modifier.padding(horizontal = 12.dp, vertical = 8.dp),
                      horizontalAlignment = Alignment.CenterHorizontally
                  ) {
                      Text(
                          text = pet.appearance.faceEmoji ?: "üê¥",
                          fontSize = 28.sp
                      )
                      Text(
                          text = pet.name,
                          fontSize = 14.sp,
                          fontWeight = if (selected) FontWeight.Bold else FontWeight.Normal
                      )
                      Text(
                          text = "Lv.${pet.level}",
                          fontSize = 12.sp
                      )
                  }
              }
          }

          @Composable
          fun SelectedPetCard(
              pet: Pet,
              onFeed: () -> Unit,
              onPlay: () -> Unit,
              onReset: () -> Unit
          ) {
              Column(
                  verticalArrangement = Arrangement.spacedBy(8.dp),
                  modifier = Modifier.fillMaxWidth()
              ) {
                  Text(
                      text = "${pet.name} ${pet.appearance.faceEmoji ?: "üê¥"}",
                      fontSize = 22.sp,
                      fontWeight = FontWeight.Bold
                  )
                  Text("–í–æ–∑—Ä–∞—Å—Ç: ${pet.ageSeconds / 60} –º–∏–Ω")
                  Text("–ú–æ–Ω–µ—Ç—ã: ${pet.coins}")
                  Text("XP: ${pet.xp}/${50 + pet.level * 20}   –£—Ä–æ–≤–µ–Ω—å: ${pet.level}")

                  StatRow("–°—ã—Ç–æ—Å—Ç—å", pet.hunger)
                  StatRow("–≠–Ω–µ—Ä–≥–∏—è", pet.energy)
                  StatRow("–°—á–∞—Å—Ç—å–µ", pet.happiness)

                  if (!pet.alive) {
                      Text(
                          text = "–ü–∏—Ç–æ–º–µ—Ü —É–º–µ—Ä üíî",
                          color = MaterialTheme.colors.error,
                          fontWeight = FontWeight.Bold
                      )
                  }

                  Row(
                      horizontalArrangement = Arrangement.spacedBy(8.dp),
                      modifier = Modifier.fillMaxWidth()
                  ) {
                      Button(
                          onClick = onFeed,
                          modifier = Modifier.weight(1f)
                      ) { Text("–ö–æ—Ä–º–∏—Ç—å") }

                      Button(
                          onClick = onPlay,
                          modifier = Modifier.weight(1f)
                      ) { Text("–ò–≥—Ä–∞—Ç—å") }
                  }

                  Row(
                      horizontalArrangement = Arrangement.spacedBy(8.dp),
                      modifier = Modifier.fillMaxWidth()
                  ) {
                      OutlinedButton(
                          onClick = onReset,
                          modifier = Modifier.weight(1f)
                      ) { Text("–°–±—Ä–æ—Å–∏—Ç—å") }
                  }
              }
          }

          @Composable
          fun StatRow(label: String, value: Int) {
              Column(
                  verticalArrangement = Arrangement.spacedBy(4.dp),
                  modifier = Modifier.fillMaxWidth()
              ) {
                  Row(
                      horizontalArrangement = Arrangement.SpaceBetween,
                      modifier = Modifier.fillMaxWidth()
                  ) {
                      Text(label)
                      Text("${value.coerceIn(0, 100)}/100")
                  }
                  LinearProgressIndicator(
                      progress = (value.coerceIn(0, 100) / 100f),
                      modifier = Modifier
                          .fillMaxWidth()
                          .height(6.dp)
                  )
              }
          }
          EOF

      - name: Remove QRUtils
        run: |
          rm -f project/app/src/main/java/com/example/tamagotchi/util/QRUtils.kt || true

      - name: Create AppearanceGenerator.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi/util
          cat <<'EOF' > project/app/src/main/java/com/example/tamagotchi/util/AppearanceGenerator.kt
          package com.example.tamagotchi.util

          import com.example.tamagotchi.model.Appearance
          import com.example.tamagotchi.model.Personality

          object AppearanceGenerator {
              fun generate(personality: Personality): Appearance {
                  val emoji = when (personality) {
                      Personality.PLAYFUL -> "üò∫"
                      Personality.LAZY -> "üò¥"
                      Personality.GREEDY -> "üòã"
                      Personality.SHY -> "üò∂"
                  }
                  return Appearance(
                      baseColorHex = "#FFC107",
                      faceEmoji = emoji,
                      accessory = null
                  )
              }
          }
          EOF

      - name: Rewrite MultiTamagotchiViewModel.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi/viewmodel
          cat <<'EOF' > project/app/src/main/java/com/example/tamagotchi/viewmodel/MultiTamagotchiViewModel.kt
          package com.example.tamagotchi.viewmodel

          import android.app.Application
          import androidx.compose.runtime.mutableStateListOf
          import androidx.compose.runtime.mutableStateOf
          import androidx.lifecycle.AndroidViewModel
          import androidx.lifecycle.viewModelScope
          import com.example.tamagotchi.data.PetsRepository
          import com.example.tamagotchi.model.*
          import com.example.tamagotchi.util.AppearanceGenerator
          import kotlinx.coroutines.delay
          import kotlinx.coroutines.launch
          import java.util.UUID

          class MultiTamagotchiViewModel(application: Application) : AndroidViewModel(application) {

              private val repo = PetsRepository(application.applicationContext)

              private val _pets = mutableStateListOf<Pet>()
              val pets: List<Pet> get() = _pets

              private val _selectedIndex = mutableStateOf(0)
              val selectedIndex: Int get() = _selectedIndex.value
              val selectedPet: Pet?
                  get() = _pets.getOrNull(selectedIndex)

              init {
                  val loaded = repo.loadAll()
                  if (loaded.isEmpty()) {
                      val personality = Personality.PLAYFUL
                      val p = Pet(
                          id = UUID.randomUUID().toString(),
                          name = "–¢–∞–º–∞",
                          personality = personality,
                          appearance = AppearanceGenerator.generate(personality)
                      )
                      _pets.add(p)
                      repo.saveAll(_pets)
                  } else {
                      _pets.addAll(loaded)
                  }
                  startTicker()
              }

              private var tickMs = 3000L

              private fun startTicker() {
                  viewModelScope.launch {
                      while (true) {
                          delay(tickMs)
                          for (i in _pets.indices) {
                              val p = _pets[i]
                              if (!p.alive) continue
                              val newHunger = (p.hunger - 2).coerceIn(0, 100)
                              val newEnergy = (p.energy - 1).coerceIn(0, 100)
                              val newHappiness = (p.happiness - 1).coerceIn(0, 100)
                              val newAge = p.ageSeconds + tickMs / 1000
                              val alive = newHunger > 0 && newEnergy > 0
                              _pets[i] = p.copy(
                                  hunger = newHunger,
                                  energy = newEnergy,
                                  happiness = newHappiness,
                                  ageSeconds = newAge,
                                  alive = alive
                              )
                          }
                          repo.saveAll(_pets)
                      }
                  }
              }

              fun select(index: Int) {
                  if (index in _pets.indices) {
                      _selectedIndex.value = index
                  }
              }

              fun addPet(name: String) {
                  val personality = Personality.values().random()
                  val p = Pet(
                      id = UUID.randomUUID().toString(),
                      name = name,
                      personality = personality,
                      appearance = AppearanceGenerator.generate(personality)
                  )
                  _pets.add(p)
                  repo.saveAll(_pets)
              }

              fun feedSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (!p.alive) return
                  _pets[idx] = p.copy(
                      hunger = (p.hunger + 20).coerceAtMost(100),
                      happiness = (p.happiness + 5).coerceAtMost(100)
                  )
                  addXPToSelected(5)
                  repo.saveAll(_pets)
              }

              fun playSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (!p.alive) return
                  _pets[idx] = p.copy(
                      happiness = (p.happiness + 15).coerceAtMost(100),
                      energy = (p.energy - 10).coerceAtLeast(0)
                  )
                  addXPToSelected(7)
                  repo.saveAll(_pets)
              }

              fun buyItem(item: ShopItem) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (p.coins < item.price) return
                  _pets[idx] = p.copy(
                      coins = p.coins - item.price,
                      hunger = (p.hunger + item.hungerRestore).coerceAtMost(100),
                      happiness = (p.happiness + item.happinessBoost).coerceAtMost(100)
                  )
                  repo.saveAll(_pets)
              }

              fun addXPToSelected(amount: Int) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  var p = _pets[idx]
                  var xp = p.xp + amount
                  var level = p.level
                  var coins = p.coins
                  val required = 50 + level * 20
                  if (xp >= required) {
                      xp -= required
                      level += 1
                      coins += 10 * level
                  }
                  _pets[idx] = p.copy(xp = xp, level = level, coins = coins)
                  repo.saveAll(_pets)
              }

              fun setReminderHoursForSelected(hours: Int) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  _pets[idx] = p.copy(reminderHours = hours)
                  repo.saveAll(_pets)
              }

              fun resetSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  _pets[idx] = p.copy(
                      hunger = 80,
                      happiness = 80,
                      energy = 80,
                      ageSeconds = 0,
                      alive = true,
                      reminderHours = 0
                  )
                  repo.saveAll(_pets)
              }

              fun exportJson(): String = repo.exportJson(_pets)

              fun importJson(json: String): List<Pet> {
                  val merged = repo.importFromJson(json)
                  _pets.clear()
                  _pets.addAll(merged)
                  return merged
              }
          }
          EOF

      - name: Rewrite AppScaffold.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi/ui
          cat <<'EOF' > project/app/src/main/java/com/example/tamagotchi/ui/AppScaffold.kt
          package com.example.tamagotchi.ui

          import androidx.compose.foundation.layout.fillMaxSize
          import androidx.compose.material.MaterialTheme
          import androidx.compose.material.Surface
          import androidx.compose.runtime.Composable
          import androidx.compose.ui.Modifier
          import androidx.lifecycle.viewmodel.compose.viewModel
          import com.example.tamagotchi.MainGameScreen
          import com.example.tamagotchi.viewmodel.MultiTamagotchiViewModel

          @Composable
          fun AppScaffold(
              vm: MultiTamagotchiViewModel = viewModel()
          ) {
              MaterialTheme {
                  Surface(
                      modifier = Modifier.fillMaxSize(),
                      color = MaterialTheme.colors.background
                  ) {
                      MainGameScreen(vm = vm)
                  }
              }
          }
          EOF

      - name: Rewrite app build.gradle
        run: |
          cat <<'EOF' > project/app/build.gradle
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace "com.example.tamagotchi"
              compileSdk 34

              defaultConfig {
                  applicationId "com.example.tamagotchi"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }

              buildFeatures {
                  compose true
              }

              composeOptions {
                  kotlinCompilerExtensionVersion "1.5.0"
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }

              kotlinOptions {
                  jvmTarget = "17"
              }
          }

          dependencies {
              def composeBom = platform("androidx.compose:compose-bom:2023.08.00")
              implementation composeBom
              androidTestImplementation composeBom

              implementation "androidx.core:core-ktx:1.13.0"
              implementation "androidx.activity:activity-compose:1.9.0"
              implementation "androidx.activity:activity-ktx:1.9.0"
              implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.6.2"
              implementation "androidx.lifecycle:lifecycle-viewmodel-compose:2.6.2"

              implementation "androidx.compose.ui:ui"
              implementation "androidx.compose.material:material"
              implementation "androidx.compose.ui:ui-tooling-preview"
              implementation "androidx.compose.material:material-icons-extended"
              debugImplementation "androidx.compose.ui:ui-tooling"

              implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3"
              implementation "com.google.code.gson:gson:2.10.1"
              implementation "androidx.work:work-runtime-ktx:2.9.0"
              implementation "com.google.mlkit:barcode-scanning:17.2.0"
          }
          EOF

      - name: Rewrite settings.gradle
        run: |
          cd project
          cat <<'EOF' > settings.gradle
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              plugins {
                  id "com.android.application" version "8.5.0"
                  id "org.jetbrains.kotlin.android" version "1.9.0"
              }
          }

          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }

          rootProject.name = "TamagotchiFull"
          include ":app"
          EOF

      - name: Create gradle.properties
        run: |
          cd project
          cat <<'EOF' > gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.workers.max=2
          EOF

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle
        run: |
          wget https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.7/bin" >> $GITHUB_PATH
          gradle -v

      - name: Build debug APK
        env:
          GRADLE_OPTS: "-Xmx3g -XX:MaxMetaspaceSize=1g"
        run: |
          cd project
          gradle :app:assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: project/app/build/outputs/apk/debug/*.apk
