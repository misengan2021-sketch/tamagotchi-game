name: Android CI (debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Unzip project
        run: |
          unzip tamagotchi_full_project.zip -d project
          ls project

      # 1) –£–¥–∞–ª—è–µ–º QRUtils, —á—Ç–æ–±—ã –Ω–µ —Ç—è–Ω—É—Ç—å zxing (–ª–∏—à–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
      - name: Remove QRUtils
        run: |
          rm -f project/app/src/main/java/com/example/tamagotchi/util/QRUtils.kt || true

      # 2) –î–æ–±–∞–≤–ª—è–µ–º AppearanceGenerator, —á—Ç–æ–±—ã ViewModel —Å–æ–±–∏—Ä–∞–ª—Å—è
      - name: Create AppearanceGenerator.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi/util
          cat <<EOF > project/app/src/main/java/com/example/tamagotchi/util/AppearanceGenerator.kt
          package com.example.tamagotchi.util

          import com.example.tamagotchi.model.Appearance
          import com.example.tamagotchi.model.Personality

          object AppearanceGenerator {
              fun generate(personality: Personality): Appearance {
                  val emoji = when (personality) {
                      Personality.PLAYFUL -> "üò∫"
                      Personality.LAZY -> "üò¥"
                      Personality.GREEDY -> "üòã"
                      Personality.SHY -> "üò∂"
                  }
                  return Appearance(
                      baseColorHex = "#FFC107",
                      faceEmoji = emoji,
                      accessory = null
                  )
              }
          }
          EOF

      # 3) –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º ViewModel —Å –Ω—É–∂–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ select/addPet/... –∏ export/import
      - name: Rewrite MultiTamagotchiViewModel.kt
        run: |
          mkdir -p project/app/src/main/java/com/example/tamagotchi/viewmodel
          cat <<EOF > project/app/src/main/java/com/example/tamagotchi/viewmodel/MultiTamagotchiViewModel.kt
          package com.example.tamagotchi.viewmodel

          import android.app.Application
          import androidx.compose.runtime.mutableStateListOf
          import androidx.compose.runtime.mutableStateOf
          import androidx.lifecycle.AndroidViewModel
          import androidx.lifecycle.viewModelScope
          import com.example.tamagotchi.data.PetsRepository
          import com.example.tamagotchi.model.*
          import com.example.tamagotchi.util.AppearanceGenerator
          import kotlinx.coroutines.delay
          import kotlinx.coroutines.launch
          import java.util.UUID

          class MultiTamagotchiViewModel(application: Application) : AndroidViewModel(application) {

              private val repo = PetsRepository(application.applicationContext)

              private val _pets = mutableStateListOf<Pet>()
              val pets: List<Pet> get() = _pets

              private val _selectedIndex = mutableStateOf(0)
              val selectedIndex: Int get() = _selectedIndex.value
              val selectedPet: Pet?
                  get() = _pets.getOrNull(selectedIndex)

              init {
                  val loaded = repo.loadAll()
                  if (loaded.isEmpty()) {
                      val personality = Personality.PLAYFUL
                      val p = Pet(
                          id = UUID.randomUUID().toString(),
                          name = "–¢–∞–º–∞",
                          personality = personality,
                          appearance = AppearanceGenerator.generate(personality)
                      )
                      _pets.add(p)
                      repo.saveAll(_pets)
                  } else {
                      _pets.addAll(loaded)
                  }
                  startTicker()
              }

              private var tickMs = 3000L

              private fun startTicker() {
                  viewModelScope.launch {
                      while (true) {
                          delay(tickMs)
                          for (i in _pets.indices) {
                              val p = _pets[i]
                              if (!p.alive) continue
                              val newHunger = (p.hunger - 2).coerceIn(0, 100)
                              val newEnergy = (p.energy - 1).coerceIn(0, 100)
                              val newHappiness = (p.happiness - 1).coerceIn(0, 100)
                              val newAge = p.ageSeconds + tickMs / 1000
                              val alive = newHunger > 0 && newEnergy > 0
                              _pets[i] = p.copy(
                                  hunger = newHunger,
                                  energy = newEnergy,
                                  happiness = newHappiness,
                                  ageSeconds = newAge,
                                  alive = alive
                              )
                          }
                          repo.saveAll(_pets)
                      }
                  }
              }

              fun select(index: Int) {
                  if (index in _pets.indices) {
                      _selectedIndex.value = index
                  }
              }

              fun addPet(name: String) {
                  val personality = Personality.values().random()
                  val p = Pet(
                      id = UUID.randomUUID().toString(),
                      name = name,
                      personality = personality,
                      appearance = AppearanceGenerator.generate(personality)
                  )
                  _pets.add(p)
                  repo.saveAll(_pets)
              }

              fun feedSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (!p.alive) return
                  _pets[idx] = p.copy(
                      hunger = (p.hunger + 20).coerceAtMost(100),
                      happiness = (p.happiness + 5).coerceAtMost(100)
                  )
                  addXPToSelected(5)
                  repo.saveAll(_pets)
              }

              fun playSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (!p.alive) return
                  _pets[idx] = p.copy(
                      happiness = (p.happiness + 15).coerceAtMost(100),
                      energy = (p.energy - 10).coerceAtLeast(0)
                  )
                  addXPToSelected(7)
                  repo.saveAll(_pets)
              }

              fun buyItem(item: ShopItem) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  if (p.coins < item.price) return
                  _pets[idx] = p.copy(
                      coins = p.coins - item.price,
                      hunger = (p.hunger + item.hungerRestore).coerceAtMost(100),
                      happiness = (p.happiness + item.happinessBoost).coerceAtMost(100)
                  )
                  repo.saveAll(_pets)
              }

              fun addXPToSelected(amount: Int) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  var p = _pets[idx]
                  var xp = p.xp + amount
                  var level = p.level
                  var coins = p.coins
                  val required = 50 + level * 20
                  if (xp >= required) {
                      xp -= required
                      level += 1
                      coins += 10 * level
                  }
                  _pets[idx] = p.copy(xp = xp, level = level, coins = coins)
                  repo.saveAll(_pets)
              }

              fun setReminderHoursForSelected(hours: Int) {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  _pets[idx] = p.copy(reminderHours = hours)
                  repo.saveAll(_pets)
              }

              fun resetSelected() {
                  val idx = selectedIndex
                  if (idx !in _pets.indices) return
                  val p = _pets[idx]
                  _pets[idx] = p.copy(
                      hunger = 80,
                      happiness = 80,
                      energy = 80,
                      ageSeconds = 0,
                      alive = true,
                      reminderHours = 0
                  )
                  repo.saveAll(_pets)
              }

              fun exportJson(): String = repo.exportJson(_pets)

              fun importJson(json: String): List<Pet> {
                  val merged = repo.importFromJson(json)
                  _pets.clear()
                  _pets.addAll(merged)
                  return merged
              }
          }
          EOF

      # 4) –ß–∏–Ω–∏–º AppScaffold: –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –¥–µ–ª–µ–≥–∞—Ç–∞ by/remember
      - name: Patch AppScaffold imports
        run: |
          cd project/app/src/main/java/com/example/tamagotchi/ui
          sed -i 's/import androidx.compose.runtime.Composable/import androidx.compose.runtime.Composable\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.setValue\nimport androidx.compose.runtime.remember\nimport androidx.compose.runtime.mutableStateOf/' AppScaffold.kt

      # 5) –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–´–í–ê–ï–ú app/build.gradle –ù–ê –°–û–í–†–ï–ú–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢
      - name: Rewrite app build.gradle
        run: |
          cat <<EOF > project/app/build.gradle
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace "com.example.tamagotchi"
              compileSdk 34

              defaultConfig {
                  applicationId "com.example.tamagotchi"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }

              buildFeatures {
                  compose true
              }

              composeOptions {
                  kotlinCompilerExtensionVersion "1.5.0"
              }

              kotlinOptions {
                  jvmTarget = "17"
              }
          }

          dependencies {
              def composeBom = platform("androidx.compose:compose-bom:2023.08.00")
              implementation composeBom
              androidTestImplementation composeBom

              implementation "androidx.core:core-ktx:1.13.0"
              implementation "androidx.activity:activity-compose:1.9.0"
              implementation "androidx.activity:activity-ktx:1.9.0"
              implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.6.2"
              implementation "androidx.lifecycle:lifecycle-viewmodel-compose:2.6.2"

              implementation "androidx.compose.ui:ui"
              implementation "androidx.compose.material:material"
              implementation "androidx.compose.ui:ui-tooling-preview"
              implementation "androidx.compose.material:material-icons-extended"
              debugImplementation "androidx.compose.ui:ui-tooling"

              implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3"
              implementation "com.google.code.gson:gson:2.10.1"
              implementation "androidx.work:work-runtime-ktx:2.9.0"
              implementation "com.google.mlkit:barcode-scanning:17.2.0"
          }
          EOF

      # settings.gradle —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
      - name: Patch settings.gradle
        run: |
          cd project
          cat <<EOF > settings.gradle
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              plugins {
                  id "com.android.application" version "8.5.0"
                  id "org.jetbrains.kotlin.android" version "1.9.0"
              }
          }

          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }

          rootProject.name = "TamagotchiFull"
          include ":app"
          EOF

      # gradle.properties: –≤–∫–ª—é—á–∞–µ–º AndroidX –∏ —Ä–µ–∂–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å Gradle
      - name: Create gradle.properties
        run: |
          cd project
          cat <<EOF > gradle.properties
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.workers.max=2
          EOF

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle
        run: |
          wget https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.7/bin" >> $GITHUB_PATH
          gradle -v

      - name: Build debug APK
        env:
          GRADLE_OPTS: "-Xmx3g -XX:MaxMetaspaceSize=1g"
        run: |
          cd project
          gradle :app:assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: project/app/build/outputs/apk/debug/*.apk
